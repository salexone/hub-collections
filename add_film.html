<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Add a Film | Hub Collections</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .container {
      background: white;
      padding: 40px;
      margin: 40px 0;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
      max-width: 600px;
      width: 90%;
    }

    h1 {
      text-align: center;
      margin-bottom: 24px;
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
    }

    button {
      background: #2563eb;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #1d4ed8;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    #search-result img {
      max-width: 100px;
      margin: 10px 0;
    }

    #status {
      margin-top: 15px;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéûÔ∏è Add a New Film</h1>

    <label for="search-query">üîç Search Movie</label>
    <input type="text" id="search-query" placeholder="Enter movie title..." />
    <button id="search-btn">Search</button>

    <div id="search-result"></div>

    <form id="film-form">
      <label>Poster URL</label>
      <input type="text" id="poster" />

      <label>Original Title</label>
      <input type="text" id="original-title" />

      <label>Portuguese Title (üáµüáπ Insert manually)</label>
      <input type="text" id="pt-title" placeholder="Ex: O Padrinho" />

      <label>Director</label>
      <input type="text" id="director" />

      <label>Main Actors</label>
      <input type="text" id="actors" />

      <label>Genre</label>
      <input type="text" id="genre" />

      <label>Duration (min)</label>
      <input type="number" id="duration" />

      <label>Format</label>
      <select id="format">
        <option value="">Select Format</option>
        <option value="DVD">DVD</option>
        <option value="Blu Ray">Blu Ray</option>
        <option value="VHS">VHS</option>
        <option value="UMD">UMD</option>
        <option value="Laser Film">Laser Film</option>
        <option value="Reel">Reel</option>
      </select>

      <label>Edition</label>
      <select id="edition">
        <option value="">Select Edition</option>
        <option value="Normal">Normal</option>
        <option value="Colecionador">Colecionador</option>
        <option value="Especial">Especial</option>
        <option value="Deluxe">Deluxe</option>
        <option value="2-Discos">2-Discos</option>
      </select>

      <button type="submit">‚ûï Add Film</button>
    </form>

    <p id="status"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";

    const TMDB_READ_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4ZTY2YmU0YWE5ODY2Y2I3MWVhM2EyNDI0Mzc3YWIxYyIsIm5iZiI6MTcyMTU1OTU1My43MTEsInN1YiI6IjY2OWNlYTAxOWUzMzVjODIwNzA5YzA3YyIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.dQMQmH0hl5bikBTkByc17Lf0Ur5B2o1z_HtGhgrC5a0";

    const firebaseConfig = {
      apiKey: "AIzaSyCUpzUXiwihGhBzGfGcEzcm1-Zf5gAyj5A",
      authDomain: "hubcollections-a001e.firebaseapp.com",
      projectId: "hubcollections-a001e",
      storageBucket: "hubcollections-a001e.appspot.com",
      messagingSenderId: "765474227726",
      appId: "1:765474227726:web:480d8f30ed57cdf77e5e5f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    onAuthStateChanged(auth, user => {
      if (!user) {
        document.getElementById("status").textContent = "You must be logged in to add films.";
        document.getElementById("film-form").style.display = "none";
        return;
      }

      document.getElementById("film-form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const film = {
          poster: document.getElementById("poster").value.trim(),
          originalTitle: document.getElementById("original-title").value.trim(),
          ptTitle: document.getElementById("pt-title").value.trim(),
          director: document.getElementById("director").value.trim(),
          actors: document.getElementById("actors").value.trim(),
          genre: document.getElementById("genre").value.trim(),
          duration: parseInt(document.getElementById("duration").value),
          format: document.getElementById("format").value,
          edition: document.getElementById("edition").value,
          ownerId: user.uid
        };

        try {
          await addDoc(collection(db, "films"), film);
          document.getElementById("status").textContent = "‚úÖ Film added successfully!";
          document.getElementById("film-form").reset();
        } catch (err) {
          console.error("Add error:", err);
          document.getElementById("status").textContent = "‚ùå Error adding film.";
        }
      });
    });

    document.getElementById("search-btn").addEventListener("click", async () => {
      const query = document.getElementById("search-query").value.trim();
      const resultContainer = document.getElementById("search-result");
      resultContainer.innerHTML = "";

      if (!query) return;

      try {
        const res = await fetch(`https://api.themoviedb.org/3/search/movie?query=${encodeURIComponent(query)}&language=en-US&page=1`, {
          headers: {
            Authorization: `Bearer ${TMDB_READ_TOKEN}`,
            accept: "application/json"
          }
        });

        const data = await res.json();
        if (!data.results.length) {
          resultContainer.textContent = "No results found.";
          return;
        }

        // Show top 5 results
        data.results.slice(0, 5).forEach(async film => {
          const movieDetailRes = await fetch(`https://api.themoviedb.org/3/movie/${film.id}?language=en-US&append_to_response=credits`, {
            headers: {
              Authorization: `Bearer ${TMDB_READ_TOKEN}`,
              accept: "application/json"
            }
          });

          const movieDetails = await movieDetailRes.json();
          const posterURL = film.poster_path ? `https://image.tmdb.org/t/p/w500${film.poster_path}` : "";

          const item = document.createElement("div");
          item.innerHTML = `
            <h3>${film.title} (${film.release_date?.slice(0,4) || "n/a"})</h3>
            ${posterURL ? `<img src="${posterURL}" />` : ""}
            <button>üéØ Use This Film</button>
            <hr/>
          `;

          item.querySelector("button").addEventListener("click", () => {
            document.getElementById("poster").value = posterURL;
            document.getElementById("original-title").value = film.original_title;
            document.getElementById("pt-title").value = ""; // Manually enter
            document.getElementById("director").value = movieDetails.credits.crew.find(p => p.job === "Director")?.name || "";
            document.getElementById("actors").value = movieDetails.credits.cast.slice(0, 2).map(a => a.name).join(", ");
            document.getElementById("genre").value = movieDetails.genres.map(g => g.name).join(", ");
            document.getElementById("duration").value = movieDetails.runtime || "";
            window.scrollTo({ top: document.getElementById("film-form").offsetTop, behavior: 'smooth' });
          });

          resultContainer.appendChild(item);
        });

      } catch (err) {
        console.error("TMDb error:", err);
        resultContainer.textContent = "‚ùå Error searching. Check console.";
      }
    });
  </script>
</body>
</html>
