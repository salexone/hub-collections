// Replace the loadFilms function and update onAuthStateChanged accordingly

onAuthStateChanged(auth, (user) => {
  if (user) {
    loadFilms(user.uid);
    document.getElementById("sort-select").addEventListener("change", () => {
      loadFilms(user.uid); // reload on sort change
    });
  } else {
    window.location.href = "index.html";
  }
});

async function loadFilms(uid) {
  filmList.innerHTML = "";
  const snapshot = await getDocs(collection(db, "films"));

  const films = [];
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const id = docSnap.id;
    if (data.ownerId && data.ownerId !== uid) return;
    films.push({ id, data });
  });

  // Sort by title A-Z
  const sortVal = document.getElementById("sort-select").value;
  if (sortVal === "az") {
    films.sort((a, b) =>
      (a.data.original_title || a.data.title || '').localeCompare(b.data.original_title || b.data.title || '')
    );
  }

  films.forEach(({ id, data }) => {
    const row = document.createElement("div");
    row.className = "film-row";
    row.innerHTML = `
      <div class="film-left">
        ${data.poster ? `<img class="film-thumb" src="${data.poster}" alt="Poster">` : '<div class="film-thumb" style="background:#ccc;"></div>'}
        <div class="film-title">${data.original_title || data.title || '—'}</div>
      </div>
      <div class="film-cell">${data.director || '—'}</div>
      <div class="film-cell">${data.country || '—'}</div>
      <div class="film-cell">${data.year || '—'}</div>
    `;

    const details = document.createElement("div");
    details.className = "film-details";
    details.innerHTML = `
      <p><strong>PT Title:</strong> ${data.pt_title || '—'}</p>
      <p><strong>Actors:</strong> ${data.actors || '—'}</p>
      <p><strong>Genre:</strong> ${data.genre || '—'}</p>
      <p><strong>Duration:</strong> ${data.duration ? data.duration + ' min' : '—'}</p>
      <p><strong>Format:</strong> ${data.format || '—'}</p>
      <p><strong>Edition:</strong> ${data.edition || '—'}</p>
      <div class="button-bar">
        <button class="edit-btn" data-id="${id}">Edit</button>
        <button class="delete-btn" data-id="${id}">Delete</button>
      </div>
    `;

    row.addEventListener("click", () => {
      const isVisible = details.style.display === "block";
      document.querySelectorAll('.film-details').forEach(el => el.style.display = "none");
      details.style.display = isVisible ? "none" : "block";
    });

    details.querySelector(".delete-btn").addEventListener("click", async (e) => {
      e.stopPropagation();
      const confirmed = confirm(`Delete "${data.title}"?`);
      if (confirmed) {
        await deleteDoc(doc(db, "films", id));
        loadFilms(uid);
      }
    });

    details.querySelector(".edit-btn").addEventListener("click", async (e) => {
      e.stopPropagation();
      const btn = e.target;
      const editing = btn.innerText === "Save";
      const ps = details.querySelectorAll("p");
      const updatedData = {};

      if (!editing) {
        ps.forEach(p => {
          const label = p.innerText.split(":")[0];
          const value = p.innerText.split(":").slice(1).join(":").trim();
          p.innerHTML = `<strong>${label}:</strong> <input type="text" value="${value}" style="width: 100%;">`;
        });
        btn.innerText = "Save";
      } else {
        ps.forEach(p => {
          const label = p.querySelector("strong").innerText.replace(":", "");
          const val = p.querySelector("input").value.trim();
          switch (label) {
            case "PT Title": updatedData.pt_title = val; break;
            case "Actors": updatedData.actors = val; break;
            case "Genre": updatedData.genre = val; break;
            case "Duration": updatedData.duration = val; break;
            case "Format": updatedData.format = val; break;
            case "Edition": updatedData.edition = val; break;
          }
          p.innerHTML = `<strong>${label}:</strong> ${val || '—'}`;
        });

        await updateDoc(doc(db, "films", id), updatedData);
        btn.innerText = "Edit";
      }
    });

    filmList.appendChild(row);
    filmList.appendChild(details);
  });
}
