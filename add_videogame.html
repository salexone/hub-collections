<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üéÆ Add Videogame</title>
  <link rel="stylesheet" href="header.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f9fafb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 600px;
      margin: 2rem auto;
      padding: 2rem;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-bottom: 1.2rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background-color: #4338ca;
    }
  </style>
</head>
<body>
<div id="header-container"></div>
<script>
  fetch('header.html')
    .then(res => res.text())
    .then(data => {
      document.getElementById('header-container').innerHTML = data;
    });
</script>
<div class="container">
  <h2>üéÆ Add a New Videogame</h2>
  <form id="videogameForm">
 
    <label for="gameSearch">üîç Search Game Title</label>
    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.2rem;">
    <input type="text" id="gameSearch" placeholder="Search for a game..." style="flex: 1;">
    <button type="button" id="searchBtn" style="flex-shrink: 0; width: auto; padding: 10px 12px;">Search</button>
    </div>
    <div id="searchResults" style="border: 1px solid #ddd; border-radius: 8px; padding: 0.5rem; margin-bottom: 1.5rem;"></div>


    <label for="poster">Poster URL</label>
    <input type="text" id="poster" name="poster">

    <label for="title">Title</label>
    <input type="text" id="title" name="title" required>

    <label for="system">System</label>
    <select id="system" name="system" required>
      <option value="">Select System</option>
      <option>Atari</option>
      <option>Famicom</option>
      <option>Super Famicom</option>
      <option>Famicom Disk</option>
      <option>NES</option>
      <option>SNES</option>
      <option>GB</option>
      <option>GB Color</option>
      <option>GBA</option>
      <option>DS</option>
      <option>3DS</option>
      <option>Gamecube</option>
      <option>Wii</option>
      <option>Wii-U</option>
      <option>Switch</option>
      <option>Master System</option>
      <option>Mega Drive</option>
      <option>Sega Saturn</option>
      <option>Gamegear</option>
      <option>Dreamcast</option>
      <option>PlayStation</option>
      <option>PlayStation 2</option>
      <option>PlayStation 3</option>
      <option>PlayStation 4</option>
      <option>PlayStation 5</option>
      <option>PSP</option>
      <option>PS Vita</option>
      <option>WonderSwan</option>
      <option>Xbox</option>
      <option>Xbox 360</option>
      <option>Xbox One</option>
      <option>Xbox XS</option>
    </select>

    <label for="year">Year</label>
    <input type="number" id="year" name="year">

    <label for="main_developer">Main Developer</label>
    <input type="text" id="main_developer" name="main_developer">

    <label for="main_publisher">Main Publisher</label>
    <input type="text" id="main_publisher" name="main_publisher">

    <label for="genre">Genre</label>
    <input type="text" id="genre" name="genre">

    <label for="series">Series</label>
    <input type="text" id="series" name="series">

    <label for="region">Region</label>
    <select id="region" name="region">
      <option value="">Select Region</option>
      <option>JAP</option>
      <option>PAL</option>
      <option>USA</option>
      <option>FREE</option>
    </select>

    <label for="conteudo">Conte√∫do</label>
    <select id="conteudo" name="conteudo">
      <option value="">Select</option>
      <option>Completo</option>
      <option>Cartucho</option>
      <option>CD</option>
      <option>Caixa</option>
    </select>

    <label for="edition">Edition</label>
    <select id="edition" name="edition">
      <option value="">Select</option>
      <option>Normal</option>
      <option>Especial</option>
      <option>Collectors</option>
      <option>Limited</option>
    </select>

    <button type="submit">Add Game</button>
  </form>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js";
  import {
    getFirestore, collection, addDoc
  } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.6.11/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCUpzUXiwihGhBzGfGcEzcm1-Zf5gAyj5A",
    authDomain: "hubcollections-a001e.firebaseapp.com",
    projectId: "hubcollections-a001e",
    storageBucket: "hubcollections-a001e.appspot.com",
    messagingSenderId: "765474227726",
    appId: "1:765474227726:web:480d8f30ed57cdf77e5e5f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const form = document.getElementById("videogameForm");

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "index.html";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        poster: form.poster.value,
        title: form.title.value,
        system: form.system.value,
        year: parseInt(form.year.value) || null,
        main_developer: form.main_developer.value,
        main_publisher: form.main_publisher.value,
        genre: form.genre.value,
        series: form.series.value,
        region: form.region.value,
        conteudo: form.conteudo.value,
        edition: form.edition.value,
        ownerId: user.uid
      };

      try {
        await addDoc(collection(db, "videogames"), data);
        alert("Videogame added successfully!");
        form.reset();
      } catch (err) {
        console.error("Error adding videogame:", err);
        alert("Something went wrong.");
      }
    });
  });
  async function getAccessToken() {
    const response = await fetch(
      'https://id.twitch.tv/oauth2/token?client_id=tvna954erunoc4fqqfc13tajfshj6h&client_secret=nj1ganxd7wgde7m1e24yaeso5gojwq&grant_type=client_credentials',
      { method: 'POST' }
    );
    const data = await response.json();
    return data.access_token;
  }

  let accessToken = null;
  getAccessToken().then(token => {
    accessToken = token;
  });

  document.getElementById('gameSearch').addEventListener('input', async function () {
    const query = this.value.trim();
    if (query.length < 3 || !accessToken) return;

    const response = await fetch('https://api.igdb.com/v4/games', {
      method: 'POST',
      headers: {
        'Client-ID': 'tvna954erunoc4fqqfc13tajfshj6h',
        'Authorization': `Bearer ${accessToken}`,
        'Content-Type': 'text/plain'
      },
      body: `search "${query}"; fields name, first_release_date, cover.url, genres.name, involved_companies.company.name, involved_companies.publisher, collection.name; limit 5;`
    });

    const games = await response.json();
    showResults(games);
  });

  function showResults(games) {
    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '';
    games.forEach(game => {
      const div = document.createElement('div');
      div.style.cursor = 'pointer';
      div.style.padding = '0.3rem';
      div.style.borderBottom = '1px solid #eee';
      div.textContent = game.name;
      div.onclick = () => fillForm(game);
      resultsDiv.appendChild(div);
    });
  }

  function fillForm(game) {
    document.getElementById('title').value = game.name || '';
    document.getElementById('year').value = game.first_release_date ? new Date(game.first_release_date * 1000).getFullYear() : '';
    
    const dev = game.involved_companies?.find(c => c.publisher === false);
    const pub = game.involved_companies?.find(c => c.publisher === true);
    document.getElementById('main_developer').value = dev?.company?.name || '';
    document.getElementById('main_publisher').value = pub?.company?.name || '';
    
    document.getElementById('genre').value = game.genres?.[0]?.name || '';
    document.getElementById('series').value = game.collection?.name || '';
    document.getElementById('poster').value = game.cover?.url ? `https:${game.cover.url.replace('t_thumb', 't_cover_big')}` : '';

    // Clear the search UI
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('gameSearch').value = '';
  }
    document.getElementById('searchBtn').addEventListener('click', () => {
    const input = document.getElementById('gameSearch');
    const event = new Event('input');
    input.dispatchEvent(event);
});

  
</script>
</body>
</html>
